---
title: "what does time tell"
author: Yue Ma
subtitle: Using time series data to train deep learning models for classification
---

# Introduction

Time series data is of tremendous importance in the field of environmental sustainability. Exploring this kind of data helps us understand the pattern of ecosystems, which allows us to detect the abnormal changes in time and help the relative department to make decisions. In this study, I will compare the performances of two state-of-the-art time series classification (TSC) models, fully convectional neural network (FCN) and deep Residual Network (ResNet).

# Materials and methods

This study can be divided into four parts:

1) data collection and pre-processing: 
In this part, I collected the aforementioned data and normalized them into the same value range (Except the NDVI data). The normalized value range for the NDVI data is [-1,1], while the normalized value range for the other environmental variables is (0,1]. 

2) build training and testing data sets:
Based the land cover classification data, I select pixels that do not change during the study period and build a mask based on them. This mask is then applied to select pixels from the NDVI and environmental variables data. Then the label from the classification data and the data from previous step are combined together and then splited into training and testing datasets.

3) build and train deep learning models:
The deep learning models used in this paper is proposed in XXX Wang's paper in 2017. In this paper, I keep the original structures of the models in the paper and 

4) discussion:
Based on the results I get from the previous step, the performances of these two models are analyzed and the results have referential significance to relative studies.

![](https://github.com/geo511-2022/final_project-YueMa28/blob/master/flowwork.png)

## Before the code

In this study I planned to use ten years as the study period, however the large size of dataset would run into 'Error: vector memory exhausted (limit reached?)' Error. So on this website, I will only use one year as the study period. If you are interested in the original code, please copy and paste the commented parts of code and run them on a powerful server.

## Demo (using data from 2018 as an example)

Here I list all the packages that I used in this study.

```{r, message=F, warning=F}
library(tensorflow)
library(raster)
library(lubridate)
library(keras)
library(sp)
library(timechange)
library(plot3D)
library(ggplot2)
library(piggyback)
library(dst)
library(reticulate)
library(countcolors)
library(tidyterra)
library(downloader)


```

## Creat time series to collect data from github
In this part we collected the time series data from Dr. Wilson's github.

```{r}

#year_list = c('2009','2010','2011','2012','2013','2014','2015','2016','2017','2018')

#date_list = list() 

#count <- 1
#for(i in year_list){ 
#  ss <- as.Date(paste(i,'-01-01',sep=''))
#  dates <- seq(from=ss, by=32, length.out=12)
#  for(j in 1:12){
#    temp <- format(dates[[j]], format = '%Y_%m_%d')
#   date_list[[count]] <- temp
#    count <- count + 1
#  }
#} 

#date_list

date_list = list() 

ss <- as.Date(paste(2018,'-01-01',sep=''))
dates <- seq(from=ss, by=32, length.out=12)
for(j in 1:12){
  temp <- format(dates[[j]], format = '%Y_%m_%d')
  date_list[[j]] <- temp
}

date_list


```


## Download and clean all required data
Here, I load all the NDVI data and compact them as one three-dimensional array. I firstly go through the data to check if there is any N.A or infinity values in the array. If there are infinity values, replace them with N.A values. 


# download the data
In this part I will show the code for downloading the data from Dr. Wilson's github. I also uploaded the data in the release so this download code is commented out. Feel free to comment it in and use it if you want to download the data by yourself.

```{r}
#ndvi_path <- "the place where you save your NDVI data"
#env_path <- "the place where you save your env data"

#download the NDVI data from Dr.Wilson's github
#for(i in 1:12){
#  sample_data <- pb_download(paste(date_list[[i]],'.tif',sep = ''),
#            repo = "AdamWilsonLab/emma_envdata",
#            tag = "raw_ndvi_modis",
#            dest = file.path(ndvi_path)
#            )
#}

#download the env data

#dem_data <- pb_download('nasadem.tif',
#            repo = "AdamWilsonLab/emma_envdata",
#            tag = "processed_static",
#            dest = file.path(env_path)
#            )

#soil_data <- pb_download('soil_Total_N_.tif',
#            repo = "AdamWilsonLab/emma_envdata",
#            tag = "processed_static",
#            dest = file.path(env_path)
#            )

#conc_data <- pb_download('MODCF_seasonality_concentration.tif',
#            repo = "AdamWilsonLab/emma_envdata",
#            tag = "processed_static",
#            dest = file.path(env_path)
#            )

```



```{r}
NDVI_filelist = c()

for(i in 1:12){
  NDVI_filelist[i] = paste('https://github.com/geo511-2022/final_project-YueMa28/releases/download/NDVI/',date_list[i],'.tif' ,sep="")
}

ndvi_rasters <- terra::rast(NDVI_filelist)
names(ndvi_rasters) <- c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")


ggplot() +
  geom_spatraster(data=ndvi_rasters) +
  facet_wrap(~lyr, ncol = 4) 

```
```{r}
ndvi_rasters_norm <- (ndvi_rasters-100)/100

ggplot() +
  geom_spatraster(data=ndvi_rasters_test) +
  facet_wrap(~lyr, ncol = 4) 

```




```{r}
ndvi_arr_norm = as.array(ndvi_rasters_norm)

print(paste("There are nan values in NDVI data: ",as.character(NaN %in% ndvi_arr_norm,seq='')))
print(paste("There are infinitive values in NDVI data: ",as.character(Inf %in% ndvi_arr_norm,seq='')))

print(paste("The min value of NDVI data (without nan): ",min(ndvi_arr_norm,na.rm = TRUE)))
print(paste("The max value of NDVI data (without nan): ",max(ndvi_arr_norm,na.rm = TRUE)))

```


```{r}
image(ndvi_arr_norm[nrow(ndvi_arr_norm):1,,1],asp=1)

```


# collect the environmental data
Here I download three static environmental data.
```{r}
env_filelist = c()

env_filelist[1] = "https://github.com/geo511-2022/final_project-YueMa28/releases/download/ENV/nasadem.tif"
env_filelist[2] = "https://github.com/geo511-2022/final_project-YueMa28/releases/download/ENV/soil_Total_N_.tif"
env_filelist[3] = "https://github.com/geo511-2022/final_project-YueMa28/releases/download/ENV/MODCF_seasonality_concentration.tif"

env_rasters <- terra::rast(env_filelist)
names(env_rasters) <- c("dem","soil","concentration")

ggplot() +
  geom_spatraster(data=env_rasters) +
  facet_wrap(~lyr, ncol = 3) 

```
Here we normalized the env data.
```{r}
env_rasters_norm1 <- terra::rast()

dem_rasters <- terra::rast(env_filelist[1])
dem_min <- terra::minmax(dem_rasters)[1]
dem_max <- terra::minmax(dem_rasters)[2]
dem_rasters_norm <- (dem_rasters - dem_min + 1) / (dem_max - dem_min + 2)
env_rasters_norm2 <- c(env_rasters_norm1,dem_rasters_norm)

soil_rasters <- terra::rast(env_filelist[2])
soil_min <- terra::minmax(soil_rasters)[1]
soil_max <- terra::minmax(soil_rasters)[2]
soil_rasters_norm <- (soil_rasters - soil_min + 1) / (soil_max - soil_min + 2)
env_rasters_norm3 <- c(env_rasters_norm2,soil_rasters_norm)

conc_rasters <- terra::rast(env_filelist[3])
conc_min <- terra::minmax(conc_rasters)[1]
conc_max <- terra::minmax(conc_rasters)[2]
conc_rasters_norm <- (conc_rasters - conc_min + 1) / (conc_max - conc_min + 2)

env_rasters_norm <- c(env_rasters_norm3,conc_rasters_norm)
names(env_rasters_norm) <- c("dem","soil","concentration")

ggplot() +
  geom_spatraster(data=env_rasters_norm) +
  facet_wrap(~lyr, ncol = 3) 

```

```{r}
env_arr = as.array(env_rasters_norm)

print(paste("There are nan values in static data: ",as.character(NaN %in% env_arr,seq='')))
print(paste("There are infinitive values in static data: ",as.character(Inf %in% env_arr,seq='')))

print(paste("The min value of static data (without nan): ",min(env_arr,na.rm = TRUE)))
print(paste("The max value of static data (without nan): ",max(env_arr,na.rm = TRUE)))

```



```{r}
#month <- c("01","02","03","04","05","06","07","08","09","10","11","12")

#prec_arr <- array(dim=c(1634,2035,120))
#current_time = 1

#for(y in 2009:2018){
#  for(m in month){
#    current_pr = terra::rast(file.path(UBbox_directory,paste("clipped_env/pr/pr_",m,"_",as.character(y),".tif",sep = "")))
#    resam = terra::rast(nrows=1634, ncols=2035,nlyrs=1)
#    pr_res = resample(current_pr,resam,method='bilinear')
#    prec_arr[,,current_time] = pr_res[,,1]
#    current_time = current_time + 1
#  }
#}

#print(paste("There are nan values in precipitation data: ",as.character(NaN %in% prec_arr,seq='')))
#print(paste("There are infinitive values in precipitation data: ",as.character(Inf %in% prec_arr,seq='')))

#print(paste("The min value of precipitation data (without nan): ",min(prec_arr,na.rm = TRUE)))
#print(paste("The max value of precipitation data (without nan): ",max(prec_arr,na.rm = TRUE)))




month <- c("01","02","03","04","05","06","07","08","09","10","11","12")

prec_arr <- array(dim=c(1634,2035,12))

current_time = 1

for(m in month){
  current_pr = terra::rast(file.path(UBbox_directory,paste("clipped_env/pr/pr_",m,"_2018.tif",sep = "")))
  resam = terra::rast(nrows=1634, ncols=2035,nlyrs=1)
  pr_res = terra::resample(current_pr,resam,method='bilinear')
  prec_arr[,,current_time] = as.array(pr_res)
  current_time = current_time + 1
}




print(paste("There are nan values in precipitation data: ",as.character(NaN %in% prec_arr,seq='')))
print(paste("There are infinitive values in precipitation data: ",as.character(Inf %in% prec_arr,seq='')))

print(paste("The min value of precipitation data (without nan): ",min(prec_arr,na.rm = TRUE)))
print(paste("The max value of precipitation data (without nan): ",max(prec_arr,na.rm = TRUE)))

```

```{r}
#norm_pr <- array(dim=c(1634,2035,120))

#for(i in 1:120){
#  norm_pr[,,i] = MaxMinNormalization(prec_arr[,,i],min(prec_arr[,,i],na.rm = TRUE)-1,max(prec_arr[,,i],na.rm = TRUE)+1)
#}

#print(paste("The min value of normalized precipitation data (without nan): ",min(norm_pr,na.rm = TRUE)))
#print(paste("The max value of normalized precipitation data (without nan): ",max(norm_pr,na.rm = TRUE)))


norm_pr <- array(dim=c(1634,2035,12))

for(i in 1:12){
  norm_pr[,,i] = MaxMinNormalization(prec_arr[,,i],min(prec_arr[,,i],na.rm = TRUE)-1,max(prec_arr[,,i],na.rm = TRUE)+1)
}

print(paste("The min value of normalized precipitation data (without nan): ",min(norm_pr,na.rm = TRUE)))
print(paste("The max value of normalized precipitation data (without nan): ",max(norm_pr,na.rm = TRUE)))

```
```{r}
#rsds_arr <- array(dim=c(1634,2035,120))
#current_time_rsds = 1

#for(y in 2009:2018){
#  for(m in month){
#    current_rsds = terra::rast(file.path(UBbox_directory,paste("clipped_env/rsds/rsds_",m,"_",as.character(y),".tif",sep = "")))
#   resam = terra::rast(nrows=1634, ncols=2035,nlyrs=1)
#    rsds_res = resample(current_rsds,resam,method='bilinear')
#    rsds_arr[,,current_time_rsds] = rsds_res[,,1]
#    current_time_rsds = current_time_rsds + 1
#  }
#}

#print(paste("There are nan values in downwelling shortwave flux data: ",as.character(NaN %in% rsds_arr,seq='')))
#print(paste("There are infinitive values in downwelling shortwave flux data: ",as.character(Inf %in% rsds_arr,seq='')))

#print(paste("The min value of downwelling shortwave flux data (without nan): ",min(rsds_arr,na.rm = TRUE)))
#print(paste("The max value of downwelling shortwave flux data (without nan): ",max(rsds_arr,na.rm = TRUE)))




rsds_arr <- array(dim=c(1634,2035,12))
current_time_rsds = 1

  for(m in month){
    current_rsds = terra::rast(file.path(UBbox_directory,paste("clipped_env/rsds/rsds_",m,"_2018.tif",sep = "")))
    resam = terra::rast(nrows=1634, ncols=2035,nlyrs=1)
    rsds_res = terra::resample(current_rsds,resam,method='bilinear')
    rsds_arr[,,current_time_rsds] = as.array(rsds_res)
    current_time_rsds = current_time_rsds + 1
}

print(paste("There are nan values in downwelling shortwave flux data: ",as.character(NaN %in% rsds_arr,seq='')))
print(paste("There are infinitive values in downwelling shortwave flux data: ",as.character(Inf %in% rsds_arr,seq='')))

print(paste("The min value of downwelling shortwave flux data (without nan): ",min(rsds_arr,na.rm = TRUE)))
print(paste("The max value of downwelling shortwave flux data (without nan): ",max(rsds_arr,na.rm = TRUE)))

```

```{r}
#norm_rsds <- array(dim=c(1634,2035,120))

#for(i in 1:120){
#  norm_rsds[,,i] = MaxMinNormalization(rsds_arr[,,i],min(rsds_arr[,,i],na.rm = TRUE)-1,max(rsds_arr[,,i],na.rm = TRUE)+1)
#}


#print(paste("The min value of downwelling shortwave flux data (without nan): ",min(norm_rsds,na.rm = TRUE)))
#print(paste("The max value of downwelling shortwave flux data (without nan): ",max(norm_rsds,na.rm = TRUE)))



norm_rsds <- array(dim=c(1634,2035,12))

for(i in 1:12){
  norm_rsds[,,i] = MaxMinNormalization(rsds_arr[,,i],min(rsds_arr[,,i],na.rm = TRUE)-1,max(rsds_arr[,,i],na.rm = TRUE)+1)
}


print(paste("The min value of normalized downwelling shortwave flux data (without nan): ",min(norm_rsds,na.rm = TRUE)))
print(paste("The max value of normalized downwelling shortwave flux data (without nan): ",max(norm_rsds,na.rm = TRUE)))

```

```{r}

#tas_arr <- array(dim=c(1634,2035,120))
#current_time_tas = 1

#for(y in 2009:2018){
#  for(m in month){
#    current_tas = terra::rast(file.path(temp_directory,paste("clipped_env/tas/tas_",m,"_",as.character(y),".tif",sep = "")))
#    resam = terra::rast(nrows=1634, ncols=2035,nlyrs=1)
#    tas_res = resample(current_tas,resam,method='bilinear')
#    tas_arr[,,current_time_tas] = tas_res[,,1]
#    current_time_tas = current_time_tas + 1
#  }
#}



tas_arr <- array(dim=c(1634,2035,12))
current_time_tas = 1


for(m in month){
  current_tas = terra::rast(file.path(UBbox_directory,paste("clipped_env/tas/tas_",m,"_2018.tif",sep = "")))
  resam = terra::rast(nrows=1634, ncols=2035,nlyrs=1)
  tas_res = terra::resample(current_tas,resam,method='bilinear')
  tas_arr[,,current_time_tas] = as.array(tas_res)
  current_time_tas = current_time_tas + 1
}

print(paste("There are nan values in mean daily airtemperature data: ",as.character(NaN %in% rsds_arr,seq='')))
print(paste("There are infinitive values in mean daily air temperature data: ",as.character(Inf %in% rsds_arr,seq='')))

print(paste("The min value of mean daily air temperature data (without nan): ",min(rsds_arr,na.rm = TRUE)))
print(paste("The max value of mean daily air temperature data (without nan): ",max(rsds_arr,na.rm = TRUE)))


```

```{r}
#norm_tas <- array(dim=c(1634,2035,120))

#for(i in 1:120){
#  norm_tas[,,i] = MaxMinNormalization(tas_arr[,,i],min(tas_arr[,,i],na.rm = TRUE)-1,max(tas_arr[,,i],na.rm = TRUE)+1)
#}

#print(paste("The min value of normalized mean daily air temperature data (without nan): ",min(norm_rsds,na.rm = TRUE)))
#print(paste("The max value of normalized mean daily air temperature data (without nan): ",max(norm_rsds,na.rm = TRUE)))


norm_tas <- array(dim=c(1634,2035,12))

for(i in 1:12){
  norm_tas[,,i] = MaxMinNormalization(tas_arr[,,i],min(tas_arr[,,i],na.rm = TRUE)-1,max(tas_arr[,,i],na.rm = TRUE)+1)
}

print(paste("The min value of normalized mean daily air temperature data (without nan): ",min(norm_rsds,na.rm = TRUE)))
print(paste("The max value of normalized mean daily air temperature data (without nan): ",max(norm_rsds,na.rm = TRUE)))
```


```{r}
#all_variables <- array(dim=c(1634,2035,120,7))

#for(i in 1:120){
#  all_variables[,,i,1] = ndvi_arr_norm[,,i]
#  all_variables[,,i,2] = env_arr[,,1]
#  all_variables[,,i,3] = env_arr[,,2]
#  all_variables[,,i,4] = env_arr[,,3]
#  all_variables[,,i,5] = norm_pr[,,i]
#  all_variables[,,i,6] = norm_rsds[,,i]
#  all_variables[,,i,7] = norm_tas[,,i]
#}


all_variables <- array(dim=c(1634,2035,12,7))

for(i in 1:12){
  for(m in 1:1634){
    for(n in 1:2035){
        all_variables[m,n,i,1] = ndvi_arr_norm[m,n,i]
        all_variables[m,n,i,2] = env_arr[m,n,1]
        all_variables[m,n,i,3] = env_arr[m,n,2]
        all_variables[m,n,i,4] = env_arr[m,n,3]
        all_variables[m,n,i,5] = norm_pr[m,n,i]
        all_variables[m,n,i,6] = norm_rsds[m,n,i]
        all_variables[m,n,i,7] = norm_tas[m,n,i]
    }
  }

}

```

```{r}
all_variables_mask <- array(dim=c(1634,2035))



for(m in 1:1634){
  for(n in 1:2035){
    #found_nan = FALSE
    if(NaN %in% all_variables[m,n,,]){
      found_nan = TRUE
      
    }
    else{
      found_nan = FALSE
    }
    
    if(found_nan){
      all_variables_mask[m,n] <- -1
    }
    else{
      all_variables_mask[m,n] <- 1
    }
  }
}
count
NaN %in% all_variables[1634,2035,,]
all_variables_mask[11,12]
1 %in% all_variables_mask
```

```{r}
class_arr <- array(dim=c(1634,2035,10))

year = c("09","10","11","12","13","14","15","16","17","18")

for(y in 1:10){
  current_class = terra::rast(file.path(temp_directory,paste("africa_classification_CFR/",year[[y]],"_CFR.tif",sep = "")))
  class_arr[,,y] = current_class[,,1]
}

class_mask <- array(dim = c(1634,2035))

for(m in 1:1634){
  for(n in 1:2035){
    found_change = FALSE
    for(t in 1:10){
      if(class_arr[m,n,1] != class_arr[m,n,t] || class_arr[m,n,1] == 0 ){
        found_change = TRUE
        break
      }
    }
    if(found_change){
      class_mask[m,n] = -1
    }
    else{
      class_mask[m,n] = 1
    }
  }
}


```

```{r}
combine_mask = array(dim = c(1634,2035))

for(m in 1:1634){
  for(n in 1:2035){
    if(all_variables_mask[m,n] == 1 && class_mask[m,n] == 1){
      combine_mask[m,n] = 1
    }
    else{
      combine_mask[m,n] = -1
    }
  }
}


```

```{r}
for(m in 1:1634){
  for(n in 1:2035){
    if(all_variables_mask[m,n] == 1 && class_mask[m,n] == 1){
      combine_mask[m,n] = 1
    }
    else{
      combine_mask[m,n] = -1
    }
  }
}

1 %in% all_variables_mask

valid_number <- 0
for(i in 1:1634){
  for(j in 1:2035){
    if(combine_mask[i,j]==1){
      valid_number = valid_number + 1
    }
    else{
      next
    }
  }
}
valid_number
train_number = as.integer(valid_number*0.75)
test_number = as.integer(valid_number*0.25)
```


```{r}
lab_dict = c('20.0'=0,
             '30.0'=1,
             '41.0'=2,
             '42.0'=3,
             '43.0'=4,
             '50.0'=5,
             '60.0'=6,
             '80.0'=7,
             '90.0'=8,
             '112.0'=9,
             '114.0'=10,
             '116.0'=11,
             '124.0'=12,
             '126.0'=13)
```


```{r}
#total_dataset = array(c(valid_number,120,7))

#total_label = array(c(valid_number,1))

#total_dataset_count = 1

#for(i in 1:1634){
#  for(j in 1:2035){
#    if(combine_mask[i,j] == 1){
#      total_dataset[total_dataset_count,,] = all_variables[i,j,,]
#      trans_lab = lab_dict[[as.character(class_arr[i,j,1])]]
#      total_label[total_dataset_count,1] = trans_lab
#      total_dataset_count = total_dataset_count+1
#    }
#  }
#}



total_dataset = array(dim=c(valid_number,12,7))

total_label = array(dim=c(valid_number,1))

total_dataset_count = 1

for(i in 1:1634){
  for(j in 1:2035){
    if(combine_mask[i,j] == 1){
      total_dataset[total_dataset_count,,] = all_variables[i,j,,]
      trans_lab = lab_dict[[as.character(class_arr[i,j,1])]]
      total_label[total_dataset_count,1] = trans_lab
      total_dataset_count = total_dataset_count+1
    }
  }
}
```


```{r}
valid_number
total_label

set.seed(10000)
random_int <- sample(1:valid_number, train_number, replace = FALSE)
train_dataset = list()
train_label = list()
test_dataset = list()
test_label = list()

total_train_num <- 1
total_test_num <- 1
for(i in 1:valid_number){
  if(i %in% random_int){
    train_dataset[[total_train_num]] <- total_dataset[,i,]
    train_label[[total_train_num]] <- total_label[i,]
    total_train_num = total_train_num + 1
  }
  else{
    test_dataset[[total_test_num]] <- total_dataset[,i,]
    test_label[[total_test_num]] <- total_label[i,]
    total_test_num = total_test_num + 1
  }
}

```
## build the training and testing dataset

Load the land cover classification dataset and compare the value of each pixel from year to year. Save the location of pixels which don't change during the study period and build a mask based on these pixels.

Use the mask to filter out the pixels in the compacted time series dataset. Then filter out all the pixels who have 0 in their environmental variables.

Convert the 3-dimensional dataset to 2-dimensional dataset. After this, add labels to the 2-dimensional dataset. Then use continuous numbers to replace the original label numbers.

Randomly split the dataset (75%-25%) as training dataset and testing dataset.

## build and train the model
Build the FCN model and train it with the training dataset.

Build the ResNet model and train it with the training dataset.

Test the models with testing dataset, and evaluate them.
```{r}
FCN_model <- keras_model_sequential()
FCN_model %>%
  layer_input(input_shape=c(120,7,1)) %>%
  layer_conv_2d(128,5,1,padding = 'same') %>%
  layer_batch_normalization() %>%
  layer_activation('relu') %>%
  layer_conv_2d(256,5,1,padding = 'same') %>%
  layer_batch_normalization() %>%
  layer_activation('relu') %>%
  layer_conv_2d(128,3,1,padding = 'same') %>%
  layer_batch_normalization() %>%
  layer_activation('relu') %>%
  layer_average_pooling_2d() %>%
  layer_dense(14,activation = 'softmax')

summary(FCN_model)

```

# Results

[~200 words]

Tables and figures (maps and other graphics) are carefully planned to convey the results of your analysis. Intense exploration and evidence of many trials and failures. The author looked at the data in many different ways before coming to the final presentation of the data.

Show tables, plots, etc. and describe them.

```{r, fig.width=6, fig.height=3, fig.cap="Map of completely random data"}
m <- leaflet(data) %>% 
  addTiles() %>% 
  addCircleMarkers(~x, ~y, radius = ~size,color = ~as.factor(category)) %>% 
  addPopups(~x[2], ~y[2], "Random popup")
m  # a map with the default OSM tile layer
```


```{r}
data %>% 
  ggplot(aes(x=x,y=y,col=category))+
  geom_point()
```

# Conclusions

[~200 words]

Clear summary adequately describing the results and putting them in context. Discussion of further questions and ways to continue investigation.

# References

All sources are cited in a consistent manner
